<script>
  const urlParams = new URLSearchParams(window.location.search);
  const appId = urlParams.get("appId");
  const token = urlParams.get("token");
  const channel = urlParams.get("channel");
  const role = urlParams.get("role"); // "host" or "audience"

  const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
  client.setClientRole(role);

  const localContainer = document.getElementById("local_video");
  const remoteContainer = document.getElementById("remote_video");
  const statusLabel = document.getElementById("status");

  async function startLive() {
    try {
      // Join the channel
      const uid = await client.join(appId, channel, token || null, null);
      statusLabel.innerText = `Joined as ${role} - UID: ${uid}`;

      if (role === "host") {
        // ðŸŽ¥ Ø¥Ù†Ø´Ø§Ø¡ ØªØ±Ø§Ùƒ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ØµÙˆØ±Ø©
        const [micTrack, camTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

        // Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø­Ù„ÙŠ
        const localPlayer = document.createElement("div");
        localPlayer.id = `player-${uid}`;
        localContainer.appendChild(localPlayer);
        camTrack.play(localPlayer);

        // Ù†Ø´Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµÙˆØª
        await client.publish([micTrack, camTrack]);
        statusLabel.innerText = "Broadcasting live...";
      }

      // ðŸ“¡ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "video") {
          const remotePlayer = document.createElement("div");
          remotePlayer.id = `player-${user.uid}`;
          remoteContainer.innerHTML = "";
          remoteContainer.appendChild(remotePlayer);
          user.videoTrack.play(remotePlayer);
          statusLabel.innerText = "Watching live stream...";
        }
      });

      client.on("user-unpublished", user => {
        const player = document.getElementById(`player-${user.uid}`);
        if (player) player.remove();
        statusLabel.innerText = "Stream ended";
      });

    } catch (err) {
      console.error(err);
      statusLabel.innerText = "Error: " + err.message;
    }
  }

  startLive();
</script>
