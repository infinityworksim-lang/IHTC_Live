<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IHTC Live</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #0e0e0e;
      color: #fff;
      text-align: center;
    }
    #container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }
    #video-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    video {
      width: 45vw;
      height: 45vh;
      border-radius: 10px;
      background: #000;
      object-fit: cover;
    }
    #start-btn {
      background-color: #0078ff;
      border: none;
      padding: 12px 24px;
      color: white;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
    }
    #start-btn:hover {
      background-color: #005bcc;
    }
  </style>
</head>
<body>
  <div id="container">
    <h2>ğŸ¥ IHTC Live Broadcast</h2>
    <div id="video-container">
      <div id="local-player"></div>
      <div id="remote-player"></div>
    </div>
    <button id="start-btn">Start Broadcast</button>
  </div>

  <script>
    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ parameters Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const appId = urlParams.get("appId");
    const token = urlParams.get("token");
    const channel = urlParams.get("channel");
    const role = urlParams.get("role") || "audience";

    console.log("AppID:", appId, "Token:", token, "Channel:", channel, "Role:", role);

    if (!appId || !channel) {
      alert("âŒ Missing appId or channel in URL");
    }

    const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });

    async function startBroadcast() {
      try {
        if (role === "host") {
          client.setClientRole("host");
          const uid = await client.join(appId, channel, token || null, null);
          const localTrack = await AgoraRTC.createMicrophoneAndCameraTracks();
          const localContainer = document.createElement("div");
          localContainer.id = `player-${uid}`;
          localContainer.style.border = "2px solid #0078ff";
          document.getElementById("local-player").append(localContainer);
          localTrack[1].play(localContainer);
          await client.publish(localTrack);
          console.log("ğŸ¤ Host publishing stream");
        } else {
          client.setClientRole("audience");
          const uid = await client.join(appId, channel, token || null, null);
          console.log("ğŸ§ Audience joined:", uid);
          client.on("user-published", async (user, mediaType) => {
            await client.subscribe(user, mediaType);
            if (mediaType === "video") {
              const remoteContainer = document.createElement("div");
              remoteContainer.id = `player-${user.uid}`;
              document.getElementById("remote-player").innerHTML = "";
              document.getElementById("remote-player").append(remoteContainer);
              user.videoTrack.play(remoteContainer);
            }
            if (mediaType === "audio") {
              user.audioTrack.play();
            }
          });
        }
      } catch (err) {
        console.error("Agora error:", err);
        alert("Agora Error: " + err.message);
      }
    }

    // Ø§Ù„Ø²Ø± ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø¶ÙŠÙ
    const startBtn = document.getElementById("start-btn");
    if (role === "audience") {
      startBtn.style.display = "none";
      // Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
      startBroadcast();
    } else {
      startBtn.addEventListener("click", startBroadcast);
    }
  </script>
</body>
</html>
