<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dr Plus Live</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body style="margin:0;padding:0;background:black;color:white;text-align:center;font-family:sans-serif;">
  <h2 id="status">Connecting...</h2>
  <div id="local_video" style="width:100%;max-height:50%;"></div>
  <div id="remote_video" style="width:100%;height:50%;background:#000;"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const appId = urlParams.get("appId");
    const token = urlParams.get("token");
    const channel = urlParams.get("channel");
    const role = urlParams.get("role"); // "host" or "audience"

    console.log("AppId:", appId);
    console.log("Token:", token);
    console.log("Channel:", channel);
    console.log("Role:", role);

    if (!appId || !channel) {
      document.getElementById("status").innerText = "❌ Missing appId or channel in URL.";
      throw new Error("Missing required parameters");
    }

    const client = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
    client.setClientRole(role || "audience");

    const localContainer = document.getElementById("local_video");
    const remoteContainer = document.getElementById("remote_video");
    const statusLabel = document.getElementById("status");

    async function startLive() {
      try {
        // ✅ join channel
        const uid = await client.join(appId, channel, token || null, null);
        statusLabel.innerText = `Joined as ${role} - UID: ${uid}`;

        if (role === "host") {
          const [micTrack, camTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
          const localPlayer = document.createElement("div");
          localPlayer.id = `player-${uid}`;
          localContainer.appendChild(localPlayer);
          camTrack.play(localPlayer);
          await client.publish([micTrack, camTrack]);
          statusLabel.innerText = "Broadcasting live...";
        }

        client.on("user-published", async (user, mediaType) => {
          await client.subscribe(user, mediaType);
          if (mediaType === "video") {
            const remotePlayer = document.createElement("div");
            remotePlayer.id = `player-${user.uid}`;
            remoteContainer.innerHTML = "";
            remoteContainer.appendChild(remotePlayer);
            user.videoTrack.play(remotePlayer);
            statusLabel.innerText = "Watching live stream...";
          }
        });

        client.on("user-unpublished", user => {
          const player = document.getElementById(`player-${user.uid}`);
          if (player) player.remove();
          statusLabel.innerText = "Stream ended";
        });

      } catch (err) {
        console.error(err);
        statusLabel.innerText = "Error: " + err.message;
      }
    }

    startLive();
  </script>
</body>
</html>
